<!-- templates/support/ticket_chat.html -->
<h2>Chat: {{ ticket.subject }}</h2>
<div id="chat-messages" style="height: 400px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px;">
    {% for msg in messages %}
        <div>
            <strong>{{ msg.sender.username }}:</strong> {{ msg.message }}
            <small>{{ msg.timestamp|date:"H:i" }}</small>
        </div>
    {% endfor %}
</div>

<form id="chat-form" style="margin-top: 10px;">
    {% csrf_token %}
    <input type="text" id="message-input" placeholder="Type your message..." style="width: 80%;" required>
    <button type="submit">Send</button>
</form>

<script>
    const ticketId = {{ ticket.id }};
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Connect to WebSocket
    const chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + ticketId + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const messageDiv = document.createElement('div');
        messageDiv.innerHTML = `<strong>${data.username}:</strong> ${data.message} <small>${new Date(data.timestamp).toLocaleTimeString()}</small>`;
        document.getElementById('chat-messages').appendChild(messageDiv);
        document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.getElementById('chat-form').onsubmit = function(e) {
        e.preventDefault();
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        if (message) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInput.value = '';
        }
    };
</script>